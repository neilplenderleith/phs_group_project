---
title: "R Notebook"
output: html_notebook
---
```{r}
library(tidyverse)
library(scales)
```

```{r}
beds <- read_csv("raw_data/non_covid_raw_data/beds_by_nhs_board_of_treatment_and_specialty.csv") %>% janitor::clean_names()
```

```{r}
beds %>% 
  filter(specialty_name == "All Acute") %>% 
  ggplot(aes(x = quarter, y = percentage_occupancy))+
  geom_line(aes(colour = hb), group = 1)+
  facet_wrap(~ hb)
```

-----------------------------------------------

```{r}
age_sex <- read_csv("raw_data/non_covid_raw_data/inpatient_and_daycase_by_nhs_board_of_treatment_age_and_sex.csv") %>% janitor::clean_names()

health_board_names <- read_csv("raw_data/non_covid_raw_data/health_board_names.csv")

age_sex %>% 
  count(hb)

season_age_sex <- age_sex %>% 
  mutate(date = yq(quarter),
         year = year(date),
         month = month(date, label = TRUE, abbr = FALSE),
         season = case_when(
           str_detect(month, "December") ~ "Winter",
           str_detect(month, "January") ~ "Winter",
           str_detect(month, "February") ~ "Winter",
           str_detect(month, "March") ~ "Spring",
           str_detect(month, "April") ~ "Spring",
           str_detect(month, "May") ~ "Spring",
           str_detect(month, "June") ~ "Summer",
           str_detect(month, "July") ~ "Summer",
           str_detect(month, "August") ~ "Summer",
           str_detect(month, "September") ~ "Autumn",
           str_detect(month, "October") ~ "Autumn",
           str_detect(month, "November") ~ "Autumn"),
         season = factor(season, order = TRUE)) 
```
```{r}

library(lubridate)
library(zoo)

# change quarter column into the date at the start of each quarter
 age_sex <-  age_sex %>% 
    mutate(quarter = yq(quarter))

 # shows the total length of stay by age bracket for emergency inpatients
age_sex %>% 
  filter(admission_type == "Emergency Inpatients") %>% 
  group_by(quarter, age) %>% 
  summarise(total_length_of_stay = sum(length_of_stay)) %>% 
  ggplot(aes(x = quarter, y = total_length_of_stay))+
  geom_line(aes(colour = age))+
  theme(axis.text.x = element_text(angle = 45))


```





```{r}
age_sex %>% 
count(admission_type)

age_sex
```

```{r}
 # shows the total length of stay by age bracket for elective inpatients
age_sex %>% 
  filter(admission_type == "Elective Inpatients") %>% 
  group_by(quarter, age) %>% 
  summarise(total_length_of_stay = sum(length_of_stay)) %>% 
  ggplot(aes(x = quarter, y = total_length_of_stay))+
  geom_line(aes(colour = age))+
  theme(axis.text.x = element_text(angle = 45))
```

```{r}
 # shows the mean length of stay by age bracket for emergency inpatients
#can facet by sex also if required
age_sex %>% 
  filter(admission_type == "Emergency Inpatients") %>% 
  group_by(quarter, age) %>% 
  summarise(avg_length_of_stay = mean(average_length_of_stay, na.rm = TRUE)) %>% 
  ggplot(aes(x = quarter, y = avg_length_of_stay))+
  geom_line(aes(colour = age))+
  theme(axis.text.x = element_text(angle = 45))
  #facet_wrap( ~ sex)

 # shows the mean length of stay by age bracket for elective inpatients
# can facet by sex 
age_sex %>% 
  filter(admission_type == "Elective Inpatients") %>% 
  group_by(quarter, age) %>% 
  summarise(avg_length_of_stay = mean(average_length_of_stay, na.rm = TRUE)) %>% 
  ggplot(aes(x = quarter, y = avg_length_of_stay))+
  geom_col(aes(fill = age), position = "dodge")+
  theme(axis.text.x = element_text(angle = 45))+
  scale_x_date(breaks = 4)
  #facet_wrap(~ sex)
```

```{r}
age_sex %>% 
  mutate(date = yq(quarter),
         year = year(date),
         month = month(date, label = TRUE, abbr = FALSE),
         season = case_when(
           str_detect(month, "December") ~ "Winter",
           str_detect(month, "January") ~ "Winter",
           str_detect(month, "February") ~ "Winter",
           str_detect(month, "March") ~ "Spring",
           str_detect(month, "April") ~ "Spring",
           str_detect(month, "May") ~ "Spring",
           str_detect(month, "June") ~ "Summer",
           str_detect(month, "July") ~ "Summer",
           str_detect(month, "August") ~ "Summer",
           str_detect(month, "September") ~ "Autumn",
           str_detect(month, "October") ~ "Autumn",
           str_detect(month, "November") ~ "Autumn"),
         season = factor(season, order = TRUE)) 
```


```{r}

age_sex %>% 
  filter(admission_type == "Emergency Inpatients") %>% 
  group_by(quarter, sex) %>% 
  summarise(avg_length_of_stay = mean(average_length_of_stay, na.rm = TRUE)) %>% 
  ggplot(aes(x = quarter, y = avg_length_of_stay))+
  geom_line(aes(colour = sex, group = sex))+
  theme(axis.text.x = element_text(angle = 45))+
  geom_smooth(aes(colour = sex, group = sex), se = FALSE)+
  geom_point(aes(colour = sex), size = 0.5)+
  labs(title = "Emergency Inpatient by gender and average length of stay")


age_sex %>% 
  filter(admission_type == "Elective Inpatients") %>% 
  group_by(quarter, sex) %>% 
  summarise(avg_length_of_stay = mean(average_length_of_stay, na.rm = TRUE)) %>% 
  ggplot(aes(x = quarter, y = avg_length_of_stay))+
  geom_line(aes(colour = sex, group = sex))+
  theme(axis.text.x = element_text(angle = 45))+
  geom_smooth(aes(colour = sex, group = sex), se = FALSE)+
  geom_point(aes(colour = sex), size = 0.5)+
  labs(title = "Elective Inpatient by gender and average length of stay")

```


```{r}
# emergency inpatient by age and avg length of stay
age_sex %>% 
  filter(admission_type == "Emergency Inpatients") %>% 
  group_by(quarter, age) %>% 
  summarise(avg_length_of_stay = mean(average_length_of_stay, na.rm = TRUE)) %>% 
  ggplot(aes(x = quarter, y = avg_length_of_stay))+
  geom_line(aes(colour = age, group = age))+
  theme(axis.text.x = element_text(angle = 45))+
  #geom_smooth(aes(colour = sex, group = sex), se = FALSE)+
  geom_point(aes(colour = age), size = 0.5)+
  labs(title = "Emergency inpatient by age and avg length of stay")

# elective inpatient by age and avg length of stay
age_sex %>% 
  filter(admission_type == "Elective Inpatients") %>% 
  group_by(quarter, age) %>% 
  summarise(avg_length_of_stay = mean(average_length_of_stay, na.rm = TRUE)) %>% 
  ggplot(aes(x = quarter, y = avg_length_of_stay))+
  geom_line(aes(colour = age, group = age))+
  theme(axis.text.x = element_text(angle = 45))+
  #geom_smooth(aes(colour = sex, group = sex), se = FALSE)+
  geom_point(aes(colour = age), size = 0.5)+
  labs(title = "Elective inpatient by age and avg length of stay")
```
```{r}
# emergency inpatient by age and avg episodes
age_sex %>% 
  filter(admission_type == "Emergency Inpatients") %>% 
  group_by(quarter, age) %>% 
  summarise(avg_episodes = mean(episodes, na.rm = TRUE)) %>% 
  ggplot(aes(x = quarter, y = avg_episodes))+
  geom_line(aes(colour = age, group = age))+
  theme(axis.text.x = element_text(angle = 45))+
  #geom_smooth(aes(colour = sex, group = sex), se = FALSE)+
  geom_point(aes(colour = age), size = 0.5)+
  labs(title = "Emergency inpatient by age and avg episodes")

# emergency inpatient by age and avg episodes
age_sex %>% 
  filter(admission_type == "Elective Inpatients") %>% 
  group_by(quarter, age) %>% 
  summarise(avg_episodes = mean(episodes, na.rm = TRUE)) %>% 
  ggplot(aes(x = quarter, y = avg_episodes))+
  geom_line(aes(colour = age, group = age))+
  theme(axis.text.x = element_text(angle = 45))+
  #geom_smooth(aes(colour = sex, group = sex), se = FALSE)+
  geom_point(aes(colour = age), size = 0.5)+
  labs(title = "Emergency inpatient by age and avg episodes")
```



```{r}
# Plot comparison of Emergency vs Elective submissions
age_sex %>% 
  filter(admission_type %in% c("Emergency Inpatients", "Elective Inpatients")) %>% 
  group_by(quarter, admission_type) %>% 
  summarise(avg_stay = mean(average_length_of_stay, na.rm = TRUE)) %>% 
  ggplot(aes(x = quarter, y = avg_stay, colour = admission_type))+
  geom_line(aes(group = admission_type))+
  geom_point()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


```{r}
# avg_stay by admission type
age_sex %>% 
  group_by(quarter, admission_type) %>% 
  summarise(avg_stay = mean(average_length_of_stay, na.rm = TRUE)) %>% 
  ggplot(aes(x = quarter, y = avg_stay, colour = admission_type))+
  geom_line(aes(group = admission_type))+
  geom_point()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


# avg_stay for all types
age_sex %>% 
  group_by(quarter) %>% 
  summarise(avg_stay = mean(average_length_of_stay, na.rm = TRUE)) %>% 
  ggplot(aes(x = quarter, y = avg_stay, group = 1))+
  geom_line(aes(group = 1))+
  geom_point()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# number of stays for all types
age_sex %>% 
  group_by(quarter) %>% 
  summarise(total_stays = sum(stays, na.rm = TRUE)) %>% 
  ggplot(aes(x = quarter, y = total_stays, group = 1))+
  geom_line(aes(group = 1))+
  geom_point()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```











```{r}
simd <- read_csv("raw_data/non_covid_raw_data/inpatient_and_daycase_by_nhs_board_of_treatment_and_simd.csv") %>% janitor::clean_names()
```
```{r}
#total episodes(hospitalisations?) by simd value
simd %>% 
  drop_na(simd) %>%
  mutate(simd = as.factor(simd)) %>% # gives each simd a separate colour
  group_by(quarter, simd) %>% 
  summarise(total_episodes = sum(episodes, na.rm = TRUE)) %>% 
  ggplot(aes(x = quarter, y = total_episodes, group = simd))+
  geom_line(aes(colour = simd))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_y_continuous(labels = scales::comma)
  
  
```


```{r}
# plot avg stay length for most and least deprived for emergency unpatients
simd %>% 
  filter(admission_type == "Emergency Inpatients", simd %in% c(1,5)) %>% 
  drop_na(simd) %>% 
  group_by(quarter,simd) %>% 
  summarise(avg_stay_length = mean(average_length_of_stay, na.rm = TRUE)) %>% 
  ggplot(aes(x = quarter, y = avg_stay_length)) +
  geom_line(aes(colour = simd, group = simd))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
```


```{r}
speciality <- read_csv("raw_data/non_covid_raw_data/inpatient_and_daycase_by_nhs_board_of_treatment_and_specialty.csv") %>% janitor::clean_names()
```

```{r}
speciality %>% 
  count(admission_type)

speciality %>% 
  count(hb)

speciality %>% 
  count(location)

speciality %>% 
  count(specialty_name)

# add averages 
speciality_averages <- speciality %>% 
  group_by(quarter, admission_type) %>% 
  mutate(avg_length_spell= mean(average_length_of_spell, na.rm = TRUE),
         avg_length_episode = mean(average_length_of_episode, na.rm = TRUE)) %>% 
  ungroup()


speciality_averages %>% 
  group_by(quarter, admission_type) %>% 
  slice(1) %>% 
  ggplot(aes(x = quarter, y = average_length_of_episode, group = admission_type)) + 
  geom_line(aes(colour = admission_type))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}
ae_wait_times <- read_csv("raw_data/non_covid_raw_data/monthly_ae_waitingtimes_202206.csv") %>% janitor::clean_names()

glimpse(ae_wait_times)

#make a date column witht eh first date of every month
ae_wait_times <- ae_wait_times %>% 
  mutate(date = ym(month), .after = month)

#make a percent column with percent of patients meeting the 4hr target time
ae_wait_times <- ae_wait_times %>% 
  mutate(percent_4hr_target_achieved = (number_meeting_target_aggregate/number_of_attendances_aggregate)*100) %>% 
mutate(percent_seen_within_8hr = ((number_of_attendances_aggregate-attendance_greater8hrs)/number_of_attendances_aggregate)*100)

# draw percentage of 4 hour wait for all years
ae_wait_times %>% 
  filter(department_type == "Emergency Department") %>% 
  group_by(date, department_type) %>% 
  summarise(avg_4hr_target_made = mean(percent_4hr_target_achieved)) %>% 
  ggplot(aes(x = date, y = avg_4hr_target_made))+
  geom_line(aes(colour = department_type))+
  scale_x_date(date_breaks = "6 months", date_labels =  "%b %Y")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size =7))+
  geom_smooth()+
  geom_vline(xintercept = as.numeric(as.Date("2008-01-01")), linetype=4)+
  geom_vline(xintercept = as.numeric(as.Date("2009-01-01")), linetype=4)+
  geom_vline(xintercept = as.numeric(as.Date("2010-01-01")), linetype=4)+
  geom_vline(xintercept = as.numeric(as.Date("2011-01-01")), linetype=4)+
  geom_vline(xintercept = as.numeric(as.Date("2012-01-01")), linetype=4)+
  geom_vline(xintercept = as.numeric(as.Date("2013-01-01")), linetype=4)+
  geom_vline(xintercept = as.numeric(as.Date("2014-01-01")), linetype=4)+
  geom_vline(xintercept = as.numeric(as.Date("2015-01-01")), linetype=4)+
  geom_vline(xintercept = as.numeric(as.Date("2016-01-01")), linetype=4)+
  geom_vline(xintercept = as.numeric(as.Date("2017-01-01")), linetype=4)+
  geom_vline(xintercept = as.numeric(as.Date("2018-01-01")), linetype=4)+
  geom_vline(xintercept = as.numeric(as.Date("2019-01-01")), linetype=4)+
  geom_vline(xintercept = as.numeric(as.Date("2020-01-01")), linetype=4)+
  labs(title = "percentage of A&E departments meeting the 4 hr target turnaround for patients",
       subtitle = "added in vertical lines for January to help")
```

```{r}
#work in progress!
ae_wait_times %>% 
  filter(department_type == "Emergency Department") %>% 
  group_by(date) %>% 
  slice(1) %>%  
  ggplot(aes(x = date, y = avg_4hr_target_made))+
  geom_line(aes(colour = department_type))+
  scale_x_date(date_breaks = "6 months", date_labels =  "%b %Y")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size =7))+
  geom_smooth()+
  geom_vline(xintercept = as.numeric(as.Date("2008-01-01")), linetype=4)+
  geom_vline(xintercept = as.numeric(as.Date("2009-01-01")), linetype=4)+
  geom_vline(xintercept = as.numeric(as.Date("2010-01-01")), linetype=4)+
  geom_vline(xintercept = as.numeric(as.Date("2011-01-01")), linetype=4)+
  geom_vline(xintercept = as.numeric(as.Date("2012-01-01")), linetype=4)+
  geom_vline(xintercept = as.numeric(as.Date("2013-01-01")), linetype=4)+
  geom_vline(xintercept = as.numeric(as.Date("2014-01-01")), linetype=4)+
  geom_vline(xintercept = as.numeric(as.Date("2015-01-01")), linetype=4)+
  geom_vline(xintercept = as.numeric(as.Date("2016-01-01")), linetype=4)+
  geom_vline(xintercept = as.numeric(as.Date("2017-01-01")), linetype=4)+
  geom_vline(xintercept = as.numeric(as.Date("2018-01-01")), linetype=4)+
  geom_vline(xintercept = as.numeric(as.Date("2019-01-01")), linetype=4)
```

